# 贪吃蛇项目开发中遇到的问题

## 1. 输入系统卡顿、按键丢失和 UI 响应延迟问题

### 问题描述

**游戏场景：** 方向键响应不跟手，快速按键时部分输入被忽略。  
**菜单/游戏结束场景：** 鼠标移动卡顿，点击延迟数秒才响应，甚至看起来像"死机"。

### 问题原因

**1. 输入检测频率过低（游戏场景）**

- 方向键检测绑定在游戏逻辑更新上（10 FPS，100ms 间隔）
- `GetAsyncKeyState` 返回调用瞬间的按键状态
- 玩家在两次检测之间快速按下并松开，输入会完全丢失

**2. 防抖逻辑 Bug（所有场景）**

```cpp
// ❌ 错误写法
if (GetAsyncKeyState(VK_SPACE) & 0x8000) {
    static bool spacePressed = false;  // if 作用域
    if (!spacePressed) { TogglePause(); spacePressed = true; }
}
else {
    static bool spacePressed = false;  // else 作用域，是不同的变量！
    spacePressed = false;
}
```

- `static` 变量在不同作用域重复声明，实际是两个独立变量
- 导致防抖失效，按键连发

**3. 鼠标消息队列积压（菜单/游戏结束场景）**

```cpp
// ❌ 错误写法
while (menuRunning) {
    if (MouseHit()) {  // 每次只处理一个消息
        MOUSEMSG msg = GetMouseMsg();
        // 处理消息...
    }
    Render();
    Sleep(50);  // 20 FPS
}
```

- **问题链条：**
  1. 菜单刷新率 20 FPS（每 50ms 处理一次）
  2. 鼠标移动产生消息的频率远高于此（~100+ FPS）
  3. `if (MouseHit())` 每帧只处理一个消息
  4. 消息队列迅速积压，导致：
     - 鼠标移动延迟数秒才显示
     - 点击事件被积压的 `WM_MOUSEMOVE` 淹没
     - 程序看起来像"卡死"

**4. 渲染浪费 CPU 资源**

- 每 10ms 渲染一次，但游戏状态 100ms 才更新一次
- 90% 的渲染是重复绘制

**5. 输入状态管理混乱（所有场景）**

- 菜单用成员变量防抖
- 游戏用 `static` 变量防抖
- 游戏结束用 `static` 变量防抖
- 三套独立系统，维护困难，容易出错

### 解决方案

**1. 实现输入缓冲系统**

```cpp
// KeyboardController 中添加
Direction bufferedInput;   // 缓存输入
bool hasBufferedInput;
bool keyState[4];          // 用于边沿检测

void CacheInput() {
    // 高频采样（~1000 FPS），边沿触发
    if (IsKeyPressed(keyUp) && !keyState[0]) {
        bufferedInput = UP;
        hasBufferedInput = true;
    }
    keyState[0] = IsKeyPressed(keyUp);
}

Direction MakeDecision(...) {
    // 低频消费（10 FPS）
    if (hasBufferedInput) {
        Direction result = bufferedInput;
        hasBufferedInput = false;
        return result;
    }
}
```

**2. 修复防抖逻辑**

```cpp
// ✅ 正确写法
void HandleInput() {
    static bool spaceWasPressed = false;  // 函数作用域声明一次
    bool spaceIsPressed = (GetAsyncKeyState(VK_SPACE) & 0x8000) != 0;

    if (spaceIsPressed && !spaceWasPressed) {  // 边沿触发
        TogglePause();
    }
    spaceWasPressed = spaceIsPressed;
}
```

**3. 分层频率架构**

```cpp
while (isRunning) {
    // UI输入检测 (~1000 FPS)
    HandleInput();
    CacheGameInput();  // 方向键采样

    // 游戏逻辑更新 (10 FPS)
    if (currentTime - lastUpdateTime >= 100ms) {
        Update();  // 消费缓冲的输入
    }

    // 渲染更新 (60 FPS)
    if (currentTime - lastRenderTime >= 16ms) {
        Render();
    }

    Sleep(1);
}
```

### 优化效果

| 指标           | 优化前   | 优化后    |
| -------------- | -------- | --------- |
| 方向键响应频率 | 10 FPS   | ~1000 FPS |
| 最大输入延迟   | 100ms    | 1ms       |
| 输入丢失       | 经常丢失 | 基本不丢  |

---

_最后更新：2025 年 12 月 5 日_
